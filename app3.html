<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×œ×§×•×— | ×—. ×¡×‘×Ÿ</title>
    
    <!-- Chosen Palette: Sea Green & Slate -->
    <!-- Application Structure Plan: This version transitions the application from a mock-data prototype to a live, data-driven SPA. The core structure remains a dashboard-centric single page application. The critical change is the removal of the entire 'mockDB' object and its replacement with a dedicated API communication layer that uses `fetch` to interact with the deployed Google Apps Script Web App. This makes the application dynamic, connecting it to the Google Sheets backend for all data operations (authentication, data retrieval, and data submission). -->
    <!-- Visualization & Content Choices: All visualizations and content blocks are now populated with live data fetched from the backend API. The core UI components (dashboard KPIs, order lists, chat) remain the same, but their data source is now external and dynamic. New order creation and chat messages are now POSTed to the live API, reflecting real-time user actions in the backend spreadsheet. Error handling for API calls has been added to provide feedback to the user in case of network or server issues. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/he.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2E8B57; /* SeaGreen */
            --primary-hover: #256d44;
            --background-color: #f8f9fa;
        }
        body { font-family: 'Rubik', sans-serif; background-color: var(--background-color); }
        .page { display: none; }
        .page.active { display: block; }
        .swal2-container { z-index: 10000; }
        .sidebar-icon {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
            margin-inline-end: 0.75rem;
            font-size: 1.5rem;
            line-height: 1;
        }
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: #f1f5f9; }
        .chat-messages::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .text-primary { color: var(--primary-color); }
        .bg-primary-light { background-color: #eaf6ef; }
        .border-primary { border-color: var(--primary-color); }

        .timeline { border-right: 2px solid #e2e8f0; padding-right: 1rem; }
        .timeline-item { position: relative; }
        .timeline-item:before {
            content: '';
            position: absolute;
            right: -6px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e2e8f0;
        }
        .timeline-item.completed:before { background-color: var(--primary-color); }
    </style>
</head>
<body class="bg-slate-50">

    <div id="login-screen" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">××¢×¨×›×ª VIP</h1>
                <p class="mt-2 text-gray-500">×—. ×¡×‘×Ÿ - ×—×•××¨×™ ×‘× ×™×™×Ÿ</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="text-sm font-medium text-gray-700">××¡×¤×¨ ×˜×œ×¤×•×Ÿ</label>
                    <input id="username" type="text" required class="w-full px-4 py-2 mt-2 text-gray-700 bg-gray-100 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">×¡×™×¡××”</label>
                    <input id="password" type="password" required class="w-full px-4 py-2 mt-2 text-gray-700 bg-gray-100 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="×”×–×Ÿ ×¡×™×¡××”">
                </div>
                <button type="submit" class="w-full py-3 font-semibold text-white bg-primary rounded-lg hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-300 btn-primary">
                    ×”×ª×—×‘×¨×•×ª
                </button>
            </form>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="flex h-screen">
            <aside id="sidebar" class="w-64 bg-white shadow-md flex-col transition-all duration-300 hidden md:flex">
                <div class="p-4 border-b">
                    <h2 class="text-2xl font-bold text-primary">×—. ×¡×‘×Ÿ</h2>
                    <p id="user-greeting" class="text-sm text-slate-500"></p>
                </div>
                <nav class="flex-1 p-4 space-y-2">
                    <a href="#dashboard" class="nav-link flex items-center px-4 py-2 text-slate-700 bg-primary-light rounded-lg font-semibold">
                        <span class="sidebar-icon">ğŸ </span> ×¨××©×™
                    </a>
                    <a href="#orders" class="nav-link flex items-center px-4 py-2 text-slate-600 hover:bg-primary-light rounded-lg">
                        <span class="sidebar-icon">ğŸ“„</span> ×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª
                    </a>
                    <a href="#catalog" class="nav-link flex items-center px-4 py-2 text-slate-600 hover:bg-primary-light rounded-lg">
                        <span class="sidebar-icon">ğŸ“–</span> ×§×˜×œ×•×’ ××•×¦×¨×™×
                    </a>
                    <a href="#communication" class="nav-link flex items-center px-4 py-2 text-slate-600 hover:bg-primary-light rounded-lg relative">
                        <span class="sidebar-icon">ğŸ’¬</span> ×ª×§×©×•×¨×ª
                        <span id="unread-indicator" class="hidden absolute top-2 right-2 w-3 h-3 bg-red-500 rounded-full"></span>
                    </a>
                </nav>
                <div class="p-4 border-t">
                    <button id="new-order-btn-sidebar" class="w-full py-2.5 px-4 font-semibold text-white rounded-lg transition-colors duration-300 btn-primary">×”×–×× ×” ×—×“×©×”</button>
                    <button id="logout-btn" class="w-full mt-2 py-2.5 px-4 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">×”×ª× ×ª×§×•×ª</button>
                </div>
            </aside>

            <main class="flex-1 flex flex-col overflow-hidden">
                <header class="flex items-center justify-between p-4 bg-white shadow-sm">
                    <button id="menu-toggle" class="text-slate-600 md:hidden">
                         <span class="text-2xl">â˜°</span>
                    </button>
                    <div id="live-clock" class="text-sm text-slate-500 font-medium hidden sm:block"></div>
                     <h2 class="text-xl font-bold text-primary md:hidden">×—. ×¡×‘×Ÿ</h2>
                     <div class="sm:hidden"></div>
                </header>
                
                <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                    <div id="dashboard-page" class="page active">
                        <h1 class="text-3xl font-bold text-slate-800 mb-6">×¡×§×™×¨×” ×›×œ×œ×™×ª</h1>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                             <div class="p-6 bg-white rounded-xl shadow-md flex items-center space-x-4 space-x-reverse">
                                <div class="text-3xl text-primary bg-primary-light p-4 rounded-full">ğŸ“¦</div>
                                <div>
                                    <p class="text-slate-500">××›×•×œ×•×ª ×¤×¢×™×œ×•×ª</p>
                                    <p id="kpi-active-containers" class="text-3xl font-bold text-slate-800">0</p>
                                </div>
                            </div>
                            <div class="p-6 bg-white rounded-xl shadow-md flex items-center space-x-4 space-x-reverse">
                                <div class="text-3xl text-yellow-500 bg-yellow-100 p-4 rounded-full">â³</div>
                                <div>
                                    <p class="text-slate-500">×”×–×× ×•×ª ×‘×˜×™×¤×•×œ</p>
                                    <p id="kpi-pending-orders" class="text-3xl font-bold text-slate-800">0</p>
                                </div>
                            </div>
                           <div class="p-6 bg-white rounded-xl shadow-md flex items-center space-x-4 space-x-reverse">
                                <div class="text-3xl text-blue-500 bg-blue-100 p-4 rounded-full">âœ…</div>
                                <div>
                                    <p class="text-slate-500">×¡×”"×› ×”×–×× ×•×ª</p>
                                    <p id="kpi-total-orders" class="text-3xl font-bold text-slate-800">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 bg-white rounded-xl shadow-md p-6">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">×”×”×–×× ×•×ª ×”××—×¨×•× ×•×ª ×©×œ×š</h2>
                            <div id="recent-orders-container" class="space-y-4"></div>
                        </div>
                    </div>

                    <div id="orders-page" class="page">
                        <h1 class="text-3xl font-bold text-slate-800 mb-6">×”×™×¡×˜×•×¨×™×™×ª ×”×–×× ×•×ª</h1>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <input type="text" id="orders-search" class="w-full mb-4 px-4 py-2 border rounded-lg" placeholder="×—×¤×© ×œ×¤×™ ×¤×¨×•×™×§×˜, ×›×ª×•×‘×ª ××• ××¡×¤×¨ ×”×–×× ×”...">
                            <div class="overflow-x-auto">
                                <table class="w-full text-right">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="p-3 font-semibold text-sm text-slate-600">×ª×¢×•×“×”</th>
                                            <th class="p-3 font-semibold text-sm text-slate-600">×¤×¨×•×™×§×˜</th>
                                            <th class="p-3 font-semibold text-sm text-slate-600">×¡×•×’ ×¤×¢×•×œ×”</th>
                                            <th class="p-3 font-semibold text-sm text-slate-600">×ª××¨×™×š</th>
                                            <th class="p-3 font-semibold text-sm text-slate-600">×¡×˜×˜×•×¡</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orders-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="catalog-page" class="page">
                        <h1 class="text-3xl font-bold text-slate-800 mb-6">×§×˜×œ×•×’ ××•×¦×¨×™×</h1>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <input type="text" id="catalog-search" class="w-full mb-4 px-4 py-2 border rounded-lg" placeholder="×—×¤×© ××•×¦×¨...">
                            <div id="catalog-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            </div>
                        </div>
                    </div>

                    <div id="communication-page" class="page">
                         <h1 class="text-3xl font-bold text-slate-800 mb-6">××¨×›×– ×”×ª×§×©×•×¨×ª</h1>
                         <div class="bg-white rounded-xl shadow-md h-[70vh] flex flex-col">
                            <div class="border-b">
                                <nav class="flex space-x-4 space-x-reverse p-2">
                                    <button data-tab="chat" class="comm-tab font-semibold px-4 py-2 rounded-lg text-primary bg-primary-light">×¦'××˜ ×¢× ×”××©×¨×“</button>
                                    <button data-tab="notifications" class="comm-tab font-semibold px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 relative">
                                        ×”×•×“×¢×•×ª ××”××¢×¨×›×ª
                                        <span id="unread-notifications-tab" class="hidden absolute -top-1 -right-1 w-4 h-4 text-xs bg-red-500 text-white rounded-full flex items-center justify-center"></span>
                                    </button>
                                </nav>
                            </div>
                            <div id="chat-panel" class="comm-panel flex-1 flex flex-col overflow-hidden">
                                <div id="chat-messages" class="chat-messages flex-1 p-4 space-y-4 overflow-y-auto"></div>
                                <div class="p-4 border-t bg-slate-50">
                                    <form id="chat-form" class="flex items-center space-x-2 space-x-reverse">
                                        <input id="chat-input" type="text" class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="×”×§×œ×“ ×”×•×“×¢×”...">
                                        <button type="submit" class="px-5 py-2 font-semibold text-white rounded-lg btn-primary">×©×œ×—</button>
                                    </form>
                                </div>
                            </div>
                             <div id="notifications-panel" class="comm-panel hidden flex-1 p-4 overflow-y-auto">
                                 <div id="notifications-list" class="space-y-4"></div>
                             </div>
                         </div>
                    </div>
                </div>
            </main>
        </div>
        <button id="new-order-btn-fab" class="md:hidden fixed bottom-6 right-6 w-14 h-14 text-white rounded-full shadow-lg flex items-center justify-center text-3xl font-light z-50 btn-primary">+</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        dayjs.locale('he');
        dayjs.extend(dayjs_plugin_relativeTime);

        const App = {
            state: {
                user: null,
                allData: {
                    orders: [],
                    projects: [],
                    catalog: [],
                    notifications: [],
                    chat: []
                },
                currentView: 'dashboard',
            },

            API_URL: 'https://script.google.com/macros/s/AKfycbzDVoU0Mi5uJ9ULF17GlO88d1Bd6iIo_plpw2oRSGLZuCMiuApQXQYK8geRUahVTBdv/exec',

            async apiCall(action, params = {}) {
                const url = new URL(this.API_URL);
                url.searchParams.set('action', action);
                for (const key in params) {
                    if (Array.isArray(params[key])) {
                        url.searchParams.set(key, JSON.stringify(params[key]));
                    } else {
                        url.searchParams.set(key, params[key]);
                    }
                }

                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || 'An unknown API error occurred.');
                    }
                    return result.data;
                } catch (error) {
                    console.error('API Call Failed:', action, error);
                    Swal.fire('×©×’×™××ª ×ª×§×©×•×¨×ª', `××™×¨×¢×” ×©×’×™××” ×‘×¤× ×™×” ×œ×©×¨×ª: ${error.message}`, 'error');
                    throw error;
                }
            },
            
            init() {
                this.cacheDOMElements();
                this.bindEvents();
                setInterval(this.updateClock.bind(this), 1000);
            },

            updateClock() {
                if (this.dom && this.dom.liveClock) {
                    this.dom.liveClock.textContent = dayjs().format('dddd, D MMMM YYYY | HH:mm:ss');
                }
            },
            
            cacheDOMElements() {
                this.dom = {
                    loginScreen: document.getElementById('login-screen'),
                    loginForm: document.getElementById('login-form'),
                    appScreen: document.getElementById('app'),
                    userGreeting: document.getElementById('user-greeting'),
                    pages: document.querySelectorAll('.page'),
                    navLinks: document.querySelectorAll('.nav-link'),
                    logoutBtn: document.getElementById('logout-btn'),
                    kpi: {
                        activeContainers: document.getElementById('kpi-active-containers'),
                        pendingOrders: document.getElementById('kpi-pending-orders'),
                        totalOrders: document.getElementById('kpi-total-orders'),
                    },
                    recentOrdersContainer: document.getElementById('recent-orders-container'),
                    ordersTableBody: document.getElementById('orders-table-body'),
                    ordersSearch: document.getElementById('orders-search'),
                    catalogGrid: document.getElementById('catalog-grid'),
                    catalogSearch: document.getElementById('catalog-search'),
                    commTabs: document.querySelectorAll('.comm-tab'),
                    commPanels: document.querySelectorAll('.comm-panel'),
                    chatMessages: document.getElementById('chat-messages'),
                    chatForm: document.getElementById('chat-form'),
                    chatInput: document.getElementById('chat-input'),
                    notificationsList: document.getElementById('notifications-list'),
                    unreadIndicator: document.getElementById('unread-indicator'),
                    unreadNotificationsTab: document.getElementById('unread-notifications-tab'),
                    newOrderBtnSidebar: document.getElementById('new-order-btn-sidebar'),
                    newOrderBtnFab: document.getElementById('new-order-btn-fab'),
                    sidebar: document.getElementById('sidebar'),
                    menuToggle: document.getElementById('menu-toggle'),
                    liveClock: document.getElementById('live-clock'),
                };
            },
            
            bindEvents() {
                this.dom.loginForm.addEventListener('submit', this.handleLogin.bind(this));
                this.dom.logoutBtn.addEventListener('click', this.handleLogout.bind(this));
                
                this.dom.navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.navigateTo(link.getAttribute('href').substring(1));
                    });
                });

                this.dom.ordersSearch.addEventListener('input', () => this.renderOrders());
                this.dom.catalogSearch.addEventListener('input', () => this.renderCatalog());

                this.dom.commTabs.forEach(tab => tab.addEventListener('click', this.handleCommTabSwitch.bind(this)));
                this.dom.chatForm.addEventListener('submit', this.handleSendMessage.bind(this));
                
                this.dom.ordersTableBody.addEventListener('click', this.handleTableClick.bind(this));
                this.dom.recentOrdersContainer.addEventListener('click', this.handleTableClick.bind(this));

                this.dom.newOrderBtnSidebar.addEventListener('click', this.openNewOrderForm.bind(this));
                this.dom.newOrderBtnFab.addEventListener('click', this.openNewOrderForm.bind(this));
                this.dom.menuToggle.addEventListener('click', () => this.dom.sidebar.classList.toggle('hidden'));
            },
            
            async handleLogin(e) {
                e.preventDefault();
                const phone = this.dom.loginForm.querySelector('#username').value;
                const password = this.dom.loginForm.querySelector('#password').value;
                Swal.fire({ title: '××ª×—×‘×¨...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                try {
                    const userData = await this.apiCall('auth', { phone, password });
                    this.state.user = userData;
                    this.state.allData.projects = userData.projects || [];
                    
                    await this.loadInitialData(phone);

                    this.dom.loginScreen.classList.add('hidden');
                    this.dom.appScreen.classList.remove('hidden');
                    this.dom.userGreeting.textContent = `×‘×¨×•×š ×”×‘×, ${this.state.user['×©×_×œ×§×•×—']}`;
                    
                    this.renderAll();
                    this.navigateTo('dashboard');
                    Swal.close();

                } catch (error) {
                    // Error is already logged by apiCall, Swal is also shown there
                }
            },
            
            async loadInitialData(phone) {
                Swal.update({ title: '×˜×•×¢×Ÿ × ×ª×•× ×™×...' });
                try {
                    const [orders, catalog, notifications] = await Promise.all([
                        this.apiCall('listByPhone', { phone }),
                        this.apiCall('listCatalog'),
                        this.apiCall('getNoticesForPhone', { phone }),
                    ]);
                    this.state.allData.orders = orders || [];
                    this.state.allData.catalog = catalog || [];
                    this.state.allData.notifications = notifications || [];
                    this.state.allData.chat = [];
                } catch (error) {
                    console.error("Failed to load initial data", error);
                }
            },

            handleLogout() {
                this.state.user = null;
                this.state.allData = { orders: [], projects: [], catalog: [], notifications: [], chat: [] };
                this.dom.loginForm.reset();
                this.dom.loginScreen.classList.remove('hidden');
                this.dom.appScreen.classList.add('hidden');
            },

            navigateTo(pageId) {
                this.state.currentView = pageId;
                this.dom.pages.forEach(page => page.classList.toggle('active', page.id === `${pageId}-page`));
                this.dom.navLinks.forEach(link => {
                    link.classList.toggle('bg-primary-light', link.getAttribute('href') === `#${pageId}`);
                    link.classList.toggle('font-semibold', link.getAttribute('href') === `#${pageId}`);
                });
                if (window.innerWidth < 768) this.dom.sidebar.classList.add('hidden');
            },

            renderAll() {
                this.renderDashboard();
                this.renderOrders();
                this.renderCatalog();
                this.renderCommunication();
            },
            
            renderDashboard() {
                const { orders } = this.state.allData;
                const pendingOrders = orders.filter(o => o.×¡×˜×˜×•×¡ === '×××ª×™×Ÿ ×œ×‘×™×¦×•×¢');
                const activeContainers = orders.filter(o => o.×¡×˜×˜×•×¡ !== '×‘×•×¦×¢' && o.×¡×˜×˜×•×¡ !== '×‘×•×˜×œ');

                this.dom.kpi.activeContainers.textContent = activeContainers.length;
                this.dom.kpi.pendingOrders.textContent = pendingOrders.length;
                this.dom.kpi.totalOrders.textContent = orders.length;
                
                this.dom.recentOrdersContainer.innerHTML = '';
                const recentOrders = [...orders].sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 3);
                
                if (recentOrders.length === 0) {
                    this.dom.recentOrdersContainer.innerHTML = `<p class="text-slate-500">×œ× × ××¦××• ×”×–×× ×•×ª ××—×¨×•× ×•×ª.</p>`;
                    return;
                }
                recentOrders.forEach(order => {
                    const statusConfig = this.getStatusConfig(order.×¡×˜×˜×•×¡);
                    const orderEl = document.createElement('div');
                    orderEl.className = 'flex justify-between items-center p-3 bg-slate-50 rounded-lg hover:shadow-md transition-shadow cursor-pointer';
                    orderEl.dataset.orderId = order.×ª×¢×•×“×”;
                    orderEl.innerHTML = `
                        <div>
                            <p class="font-semibold text-slate-800">${order.×¤×¨×•×™×§×˜} - ${order.×¡×•×’_×¤×¢×•×œ×”}</p>
                            <p class="text-sm text-slate-500">${order.×ª×¢×•×“×”} - × ×•×¦×¨×” ${dayjs(order.created_at).fromNow()}</p>
                        </div>
                        <span class="text-sm font-medium px-2.5 py-1 rounded-full ${statusConfig.className}">${order.×¡×˜×˜×•×¡}</span>
                    `;
                    this.dom.recentOrdersContainer.appendChild(orderEl);
                });
            },

             getStatusConfig(status) {
                switch(status) {
                    case '×‘×•×¦×¢': return { className: 'bg-green-100 text-green-700', icon: 'âœ…' };
                    case '×××ª×™×Ÿ ×œ×‘×™×¦×•×¢': return { className: 'bg-yellow-100 text-yellow-700', icon: 'â³' };
                    case '×‘×“×¨×š': return { className: 'bg-blue-100 text-blue-700', icon: 'ğŸšš' };
                    case '×‘×•×˜×œ': return { className: 'bg-red-100 text-red-700', icon: 'âŒ' };
                    default: return { className: 'bg-slate-100 text-slate-700', icon: 'ğŸ“„' };
                }
            },
            
            renderOrders() {
                const searchTerm = this.dom.ordersSearch.value.toLowerCase();
                const filteredOrders = this.state.allData.orders.filter(order => 
                    (order.×¤×¨×•×™×§×˜ && order.×¤×¨×•×™×§×˜.toLowerCase().includes(searchTerm)) ||
                    (order.×›×ª×•×‘×ª && order.×›×ª×•×‘×ª.toLowerCase().includes(searchTerm)) ||
                    (order.×ª×¢×•×“×” && order.×ª×¢×•×“×”.toLowerCase().includes(searchTerm))
                );
                this.dom.ordersTableBody.innerHTML = '';
                 if (filteredOrders.length === 0) {
                    this.dom.ordersTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-slate-500">×œ× × ××¦××• ×”×–×× ×•×ª.</td></tr>`;
                    return;
                }
                filteredOrders.forEach(order => {
                    const statusConfig = this.getStatusConfig(order.×¡×˜×˜×•×¡);
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-slate-50 cursor-pointer';
                    row.dataset.orderId = order.×ª×¢×•×“×”;
                    row.innerHTML = `
                        <td class="p-3">${order.×ª×¢×•×“×”}</td>
                        <td class="p-3">${order.×¤×¨×•×™×§×˜}</td>
                        <td class="p-3">${order.×¡×•×’_×¤×¢×•×œ×”}</td>
                        <td class="p-3">${dayjs(order.created_at).format('DD/MM/YYYY')}</td>
                        <td class="p-3"><span class="text-sm font-medium px-2.5 py-1 rounded-full ${statusConfig.className}">${order.×¡×˜×˜×•×¡}</span></td>
                    `;
                    this.dom.ordersTableBody.appendChild(row);
                });
            },

            renderCatalog() {
                const searchTerm = this.dom.catalogSearch.value.toLowerCase();
                const filteredCatalog = this.state.allData.catalog.filter(item => 
                    item.productName && item.productName.toLowerCase().includes(searchTerm)
                );
                this.dom.catalogGrid.innerHTML = '';
                if (filteredCatalog.length === 0) {
                     this.dom.catalogGrid.innerHTML = `<p class="text-slate-500 col-span-full text-center">×œ× × ××¦××• ××•×¦×¨×™×.</p>`;
                     return;
                }
                filteredCatalog.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'border rounded-lg p-4 flex flex-col items-center text-center shadow-sm';
                    card.innerHTML = `
                        <img src="${item.imageUrl || 'https://placehold.co/200x150/e2e8f0/adb5bd?text=×ª××•× ×”'}" alt="${item.productName}" class="w-full h-32 object-cover rounded-md mb-4">
                        <h3 class="font-semibold text-slate-800">${item.productName}</h3>
                        <p class="text-sm text-slate-500 flex-1 mt-2">${item.description || ''}</p>
                        <button class="mt-4 w-full py-2 text-sm font-semibold text-white rounded-lg btn-primary" disabled>×”×•×¡×£ ×œ×”×–×× ×”</button>
                    `;
                    this.dom.catalogGrid.appendChild(card);
                });
            },
            
            renderCommunication() {
                this.renderChat();
                this.renderNotifications();
                this.updateUnreadIndicators();
            },

            renderChat() { 
                this.dom.chatMessages.innerHTML = `<p class="text-center text-slate-500 p-4">×¤×™×¦'×¨ ×¦'××˜ ×‘×¤×™×ª×•×—.</p>`;
            },

            renderNotifications() {
                this.dom.notificationsList.innerHTML = '';
                const notifications = [...this.state.allData.notifications].sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
                if (notifications.length === 0) { this.dom.notificationsList.innerHTML = `<p class="text-center p-4 text-slate-500">××™×Ÿ ×”×•×“×¢×•×ª ×—×“×©×•×ª.</p>`; return; }
                notifications.forEach(n => {
                    const isRead = n.read_by && n.read_by.includes(this.state.user.phone);
                    const notifEl = document.createElement('div');
                    notifEl.className = `p-4 border-r-4 rounded-md ${isRead ? 'bg-white border-slate-300' : 'bg-primary-light border-primary'}`;
                    notifEl.innerHTML = `<p class="font-bold text-slate-800">${n.title}</p><p class="text-slate-600 mt-1">${n.message}</p><p class="text-xs text-slate-400 mt-2">${dayjs(n.created_at).format('DD/MM/YY HH:mm')}</p>`;
                    this.dom.notificationsList.appendChild(notifEl);
                });
            },

            updateUnreadIndicators() {
                const unreadNotifs = this.state.allData.notifications.filter(n => !(n.read_by && n.read_by.includes(this.state.user.phone))).length;
                this.dom.unreadIndicator.classList.toggle('hidden', unreadNotifs === 0);
                this.dom.unreadNotificationsTab.classList.toggle('hidden', unreadNotifs === 0);
                if(unreadNotifs > 0) { this.dom.unreadNotificationsTab.textContent = unreadNotifs; }
            },
            
            handleCommTabSwitch(e) {
                const targetTab = e.currentTarget.dataset.tab;
                this.dom.commTabs.forEach(tab => {
                    const isSelected = tab.dataset.tab === targetTab;
                    tab.classList.toggle('bg-primary-light', isSelected);
                    tab.classList.toggle('text-primary', isSelected);
                    tab.classList.toggle('hover:bg-slate-100', !isSelected);
                    tab.classList.toggle('text-slate-600', !isSelected);
                });
                this.dom.commPanels.forEach(panel => {
                    panel.classList.toggle('hidden', panel.id !== `${targetTab}-panel`);
                });
            },

            async handleSendMessage(e) { e.preventDefault(); },
            
            handleTableClick(e) {
                const row = e.target.closest('[data-order-id]');
                if (!row) return;
                const orderId = row.dataset.orderId;
                const order = this.state.allData.orders.find(o => o.×ª×¢×•×“×” === orderId);
                if (order) {
                    this.showOrderDetail(order);
                }
            },

            showOrderDetail(order) {
                let timelineHtml = '<p class="text-slate-500">×œ× ×§×™×™××ª ×”×™×¡×˜×•×¨×™×” ×¢×‘×•×¨ ×”×–×× ×” ×–×•.</p>';
                if (order.history && Array.isArray(order.history) && order.history.length > 0) {
                    timelineHtml = order.history.map(item => `
                        <div class="timeline-item completed pb-4">
                            <p class="font-semibold text-slate-700">${item.status}</p>
                            <p class="text-sm text-slate-500">${dayjs(item.date).format('DD/MM/YYYY, HH:mm')}</p>
                        </div>
                    `).join('');
                }

                Swal.fire({
                    width: '800px',
                    showCloseButton: true,
                    showConfirmButton: false,
                    html: `
                        <div class="text-right p-4">
                            <div class="border-b pb-4 mb-4">
                                <h2 class="text-2xl font-bold text-slate-800">×¤×¨×˜×™ ×”×–×× ×”: ${order.×ª×¢×•×“×”}</h2>
                                <p class="text-slate-500">${order.×¤×¨×•×™×§×˜} - ${order.×›×ª×•×‘×ª}</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="font-bold mb-2">×¦×™×¨ ×–××Ÿ</h3>
                                    <div class="timeline">${timelineHtml}</div>
                                </div>
                                <div>
                                    <h3 class="font-bold mb-2">×¤×¨×˜×™×</h3>
                                    <ul class="space-y-2 text-slate-600">
                                        <li><strong>×¡×˜×˜×•×¡:</strong> ${order.×¡×˜×˜×•×¡}</li>
                                        <li><strong>×¡×•×’ ×¤×¢×•×œ×”:</strong> ${order.×¡×•×’_×¤×¢×•×œ×”}</li>
                                        <li><strong>×ª××¨×™×š ×™×¦×™×¨×”:</strong> ${dayjs(order.created_at).format('DD/MM/YYYY')}</li>
                                    </ul>
                                    <div class="mt-6">
                                        <a href="${order.×›×ª×•×‘×ª_waze_link || `https://waze.com/ul?q=${encodeURIComponent(order.×›×ª×•×‘×ª)}`}" target="_blank" class="inline-block w-full text-center p-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 mb-2">× ×•×•×˜ ×¢× Waze</a>
                                        <button class="w-full p-2 rounded-lg bg-slate-200 hover:bg-slate-300" disabled>×¦×•×¨ ×§×©×¨ ×œ×’×‘×™ ×”×–×× ×” ×–×•</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `
                });
            },

            async openNewOrderForm() {
                const projects = this.state.allData.projects;
                if (!projects || projects.length === 0) {
                    Swal.fire('×©×’×™××”', '×œ× ××©×•×™×›×™× ×¤×¨×•×™×§×˜×™× ×œ×—×©×‘×•× ×š. ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ×”×–×× ×”.', 'warning');
                    return;
                }
                const projectOptions = projects.map(p => `<option value="${p.projectName}|${p.projectAddress}">${p.projectName} (${p.projectAddress})</option>`).join('');

                const { value: formValues } = await Swal.fire({
                    title: '×™×¦×™×¨×ª ×”×–×× ×” ×—×“×©×”',
                    html: `
                        <select id="swal-project" class="swal2-select">${projectOptions}</select>
                        <select id="swal-action" class="swal2-select">
                            <option value="×”×¦×‘×”">×”×¦×‘×ª ××›×•×œ×”</option>
                            <option value="×”×—×œ×¤×”">×”×—×œ×¤×ª ××›×•×œ×”</option>
                            <option value="×¤×™× ×•×™">×¤×™× ×•×™ ××›×•×œ×”</option>
                        </select>
                        <textarea id="swal-notes" class="swal2-textarea" placeholder="×”×¢×¨×•×ª × ×•×¡×¤×•×ª (××•×¤×¦×™×•× ×œ×™)"></textarea>
                    `,
                    focusConfirm: false,
                    preConfirm: () => {
                        const projectSelection = document.getElementById('swal-project').value.split('|');
                        return {
                            projectName: projectSelection[0],
                            projectAddress: projectSelection[1],
                            actionType: document.getElementById('swal-action').value,
                            notes: document.getElementById('swal-notes').value,
                            items: []
                        }
                    },
                    showCancelButton: true,
                    confirmButtonText: '×©×œ×— ×‘×§×©×”',
                    cancelButtonText: '×‘×™×˜×•×œ',
                });

                if (formValues) {
                    Swal.fire({ title: '×©×•×œ×— ×‘×§×©×”...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    try {
                        const orderPayload = {
                           phone: this.state.user['×˜×œ×¤×•×Ÿ_×œ×§×•×—'],
                           clientId: this.state.user.clientId,
                           clientName: this.state.user['×©×_×œ×§×•×—'],
                           project: formValues.projectName,
                           address: formValues.projectAddress,
                           actionType: formValues.actionType,
                           items: formValues.items,
                           notes: formValues.notes
                        };
                        const result = await this.apiCall('createOrder', orderPayload);
                        await this.loadInitialData(this.state.user['×˜×œ×¤×•×Ÿ_×œ×§×•×—']);
                        this.renderAll();
                        Swal.fire('× ×©×œ×—!', `×”×–×× ×” ${result.orderId} × ×•×¦×¨×” ×‘×”×¦×œ×—×”.`, 'success');
                    } catch(e) {
                        // Error Swal is already handled in apiCall
                    }
                }
            }
        };

        App.init();
    });
    </script>
</body>
</html>

